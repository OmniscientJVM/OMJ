plugins {
    id 'com.github.johnrengelman.shadow' version '5.2.0'
}

description = "The Agent."

dependencies {
    implementation group: "org.ow2.asm", name: "asm", version: property("asm.version")
    implementation group: "org.ow2.asm", name: "asm-util", version: property("asm.version")
    implementation group: "net.bytebuddy", name: "byte-buddy", version: property("byte-buddy.version")
    implementation project(":agent-lib")

    testImplementation group: "org.junit.jupiter", name: "junit-jupiter-api", version: property("junit.version")
    testImplementation group: "org.junit.jupiter", name: "junit-jupiter-engine", version: property("junit.version")
    testRuntime project(path: ":agent", configuration: "shadow")
}

test {
    useJUnitPlatform()
}

jar {
    manifest {
        attributes(
                "Premain-Class": "com.octogonapus.omj.agent.Agent",
                "Can-Redefine-Classes": "true",
                "Can-Retransform-Classes": "true",
                "Can-Set-Native-Method-Prefix": "true"
        )
    }
}

def agentLibName = "agent-lib-all"
def agentLibAllResource = buildDir.toPath().resolve(agentLibName)

def copyAgentLibShadowJarTask = task("copyAgentLibShadowJar", type: Copy) {
    dependsOn(":agent-lib:shadowJar")
    from({ project(":agent-lib").tasks.named("shadowJar") })
    into(buildDir)
    rename { agentLibName }
}

shadowJar {
    dependsOn(copyAgentLibShadowJarTask)
    from({ agentLibAllResource })
}
