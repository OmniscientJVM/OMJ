trigger:
  branches:
    include:
      - '*'
  tags:
    include:
      - '*'

stages:
- stage: Build
  jobs:
    - job: Linux

      pool:
        vmImage: ubuntu-18.04

      steps:
        - bash: wget https://cdn.azul.com/zulu/bin/zulu14.28.21-ca-jdk14.0.1-linux_x64.tar.gz

        - task: JavaToolInstaller@0
          inputs:
            verisonSpec: "14"
            jdkArchitectureOption: x64
            jdkSourceOption: LocalDirectory
            jdkFile: "zulu14.28.21-ca-jdk14.0.1-linux_x64.tar.gz"
            jdkDestinationDirectory: '$(agent.toolsDirectory)/jdk14'
            cleanDestinationDirectory: true

        - task: Gradle@2
          displayName: 'Check'
          inputs:
            workingDirectory: ''
            gradleWrapperFile: 'gradlew'
            options: '--stacktrace -PlogTests'
            publishJUnitResults: true
            testResultsFiles: '**/TEST-*.xml'
            tasks: 'check'

        - task: Gradle@2
          displayName: 'JacocoRootReport'
          inputs:
            workingDirectory: ''
            gradleWrapperFile: 'gradlew'
            options: '--stacktrace -PlogTests'
            publishJUnitResults: true
            testResultsFiles: '**/TEST-*.xml'
            tasks: 'jacocoRootReport'

        - bash: bash <(curl -s https://codecov.io/bash) || echo 'Codecov failed to upload'
          displayName: 'CodeCov'
          workingDirectory: ''

    - job: MacOS

      pool:
        vmImage: macOS-10.14

      steps:
        - bash: wget https://cdn.azul.com/zulu/bin/zulu14.28.21-ca-jdk14.0.1-macosx_x64.tar.gz

        - task: JavaToolInstaller@0
          inputs:
            verisonSpec: "14"
            jdkArchitectureOption: x64
            jdkSourceOption: LocalDirectory
            jdkFile: "zulu14.28.21-ca-jdk14.0.1-macosx_x64.tar.gz"
            jdkDestinationDirectory: '$(agent.toolsDirectory)/jdk14'
            cleanDestinationDirectory: true

        - task: Gradle@2
          displayName: 'Check'
          inputs:
            workingDirectory: ''
            gradleWrapperFile: 'gradlew'
            options: '--stacktrace -PlogTests'
            publishJUnitResults: false
            tasks: 'check'

        - task: Gradle@2
          displayName: 'JacocoRootReport'
          inputs:
            workingDirectory: ''
            gradleWrapperFile: 'gradlew'
            options: '--stacktrace -PlogTests'
            publishJUnitResults: true
            testResultsFiles: '**/TEST-*.xml'
            tasks: 'jacocoRootReport'

    - job: Windows

      pool:
        vmImage: windows-2019

      steps:
        - powershell: "$ProgressPreference = 'SilentlyContinue'\nInvoke-WebRequest -URI https://cdn.azul.com/zulu/bin/zulu14.28.21-ca-jdk14.0.1-win_x64.zip -OutFile zulu14.28.21-ca-jdk14.0.1-win_x64.zip"

        - task: JavaToolInstaller@0
          inputs:
            verisonSpec: "14"
            jdkArchitectureOption: x64
            jdkSourceOption: LocalDirectory
            jdkFile: "zulu14.28.21-ca-jdk14.0.1-win_x64.zip"
            jdkDestinationDirectory: '$(agent.toolsDirectory)/jdk14'
            cleanDestinationDirectory: true

        - task: Gradle@2
          displayName: 'Check'
          inputs:
            workingDirectory: ''
            gradleWrapperFile: 'gradlew'
            options: '--stacktrace --scan -PlogTests'
            publishJUnitResults: false
            tasks: 'check'

        - task: Gradle@2
          displayName: 'JacocoRootReport'
          inputs:
            workingDirectory: ''
            gradleWrapperFile: 'gradlew'
            options: '--stacktrace -PlogTests'
            publishJUnitResults: true
            testResultsFiles: '**/TEST-*.xml'
            tasks: 'jacocoRootReport'
